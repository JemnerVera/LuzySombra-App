// =====================================================
// ERASER.IO - Schema evalImagen
// Base de Datos: BD_PACKING_AGROMIGIVA_DESA
// =====================================================
// 
// INSTRUCCIONES:
// 1. Abre eraser.io y crea un nuevo Entity Relational Diagram
// 2. Haz clic en "Code" (botÃ³n en la parte superior)
// 3. Pega este cÃ³digo completo
// 4. Haz clic en "Apply" o "Update"
//
// =====================================================

// =====================================================
// TABLAS EXTERNAS (Referencias - Schema GROWER/MAST)
// =====================================================
GROWER_LOT [icon: package, color: gray] {
  lotID int pk
  note: "Tabla externa - Lotes de cultivo"
}

GROWER_FARMS [icon: building, color: gray] {
  farmID string pk
  note: "Tabla externa - Fundos"
}

GROWER_STAGE [icon: layers, color: gray] {
  stageID int pk
  note: "Tabla externa - Sectores/Etapas"
}

GROWER_VARIETY [icon: leaf, color: gray] {
  varietyID int pk
  note: "Tabla externa - Variedades"
}

MAST_USERS [icon: user, color: gray] {
  userID int pk
  note: "Tabla externa - Usuarios del sistema (auditorÃ­a)"
}

// =====================================================
// GRUPO 1: CORE - AnÃ¡lisis y EvaluaciÃ³n
// =====================================================

AnalisisImagen [icon: image, color: blue] {
  analisisID int pk
  lotID int
  hilera string
  planta string
  filename string
  fechaCaptura timestamp
  porcentajeLuz decimal
  porcentajeSombra decimal
  latitud decimal
  longitud decimal
  processedImageUrl string
  originalImageUrl string
  modeloVersion string
  statusID int
  usuarioCreaID int
  fechaCreacion timestamp
  note: "ðŸ“¸ Fotos procesadas desde AgriQR o web"
}

UmbralLuz [icon: gauge, color: orange] {
  umbralID int pk
  variedadID int
  usuarioCreaID int
  usuarioActualizaID int
  tipo string
  minPorcentajeLuz decimal
  maxPorcentajeLuz decimal
  descripcion string
  colorHex string
  orden int
  activo boolean
  fechaCreacion timestamp
  fechaActualizacion timestamp
  statusID int
  note: "âš™ï¸ Umbrales de luz configurados por usuarios web"
}

LoteEvaluacion [icon: bar-chart, color: green] {
  loteEvaluacionID int pk
  lotID int
  variedadID int
  fundoID string
  sectorID int
  umbralIDActual int
  porcentajeLuzPromedio decimal
  porcentajeLuzMin decimal
  porcentajeLuzMax decimal
  porcentajeSombraPromedio decimal
  porcentajeSombraMin decimal
  porcentajeSombraMax decimal
  tipoUmbralActual string
  fechaUltimaEvaluacion timestamp
  fechaPrimeraEvaluacion timestamp
  totalEvaluaciones int
  periodoEvaluacionDias int
  fechaUltimaActualizacion timestamp
  statusID int
  note: "ðŸ“Š EvaluaciÃ³n agregada por lote (calculada por SP)"
}

// =====================================================
// GRUPO 2: ALERTAS Y NOTIFICACIONES
// =====================================================

Alerta [icon: alert-triangle, color: red] {
  alertaID int pk
  lotID int
  loteEvaluacionID int
  umbralID int
  variedadID int
  usuarioResolvioID int
  porcentajeLuzEvaluado decimal
  tipoUmbral string
  severidad string
  estado string
  fechaCreacion timestamp
  fechaEnvio timestamp
  fechaResolucion timestamp
  notas string
  statusID int
  note: "ðŸš¨ Alertas generadas automÃ¡ticamente por triggers"
}

Mensaje [icon: mail, color: green] {
  mensajeID int pk
  alertaID int
  fundoID string
  tipoMensaje string
  asunto string
  cuerpoHTML string
  cuerpoTexto string
  destinatarios string
  destinatariosCC string
  destinatariosBCC string
  estado string
  fechaCreacion timestamp
  fechaEnvio timestamp
  intentosEnvio int
  ultimoIntentoEnvio timestamp
  resendMessageID string
  resendResponse string
  errorMessage string
  statusID int
  note: "ðŸ“§ Mensajes de email enviados vÃ­a Resend API"
}

MensajeAlerta [icon: link, color: gray] {
  mensajeID int pk
  alertaID int pk
  fechaCreacion timestamp
  statusID int
  note: "ðŸ”— RelaciÃ³n N:N entre Mensajes y Alertas (mensajes consolidados)"
}

// =====================================================
// GRUPO 3: USUARIOS Y DISPOSITIVOS
// =====================================================

Dispositivo [icon: smartphone, color: purple] {
  dispositivoID int pk
  deviceId string
  apiKey string
  nombreDispositivo string
  modeloDispositivo string
  versionApp string
  activo boolean
  fechaRegistro timestamp
  ultimoAcceso timestamp
  statusID int
  usuarioCreaID int
  fechaCreacion timestamp
  usuarioModificaID int
  fechaModificacion timestamp
  note: "ðŸ“± Dispositivos Android (AgriQR) - AutenticaciÃ³n con deviceId + apiKey"
}

UsuarioWeb [icon: user-circle, color: teal] {
  usuarioID int pk
  username string
  passwordHash string
  email string
  nombreCompleto string
  rol string
  activo boolean
  intentosLogin int
  bloqueadoHasta timestamp
  ultimoAcceso timestamp
  statusID int
  usuarioCreaID int
  fechaCreacion timestamp
  usuarioModificaID int
  fechaModificacion timestamp
  note: "ðŸ‘¤ Usuarios web - AutenticaciÃ³n con username + password (roles: Admin, Agronomo, Supervisor, Lector)"
}

Contacto [icon: users, color: blue] {
  contactoID int pk
  fundoID string
  sectorID int
  usuarioCreaID int
  usuarioActualizaID int
  nombre string
  email string
  telefono string
  tipo string
  rol string
  recibirAlertasCriticas boolean
  recibirAlertasAdvertencias boolean
  recibirAlertasNormales boolean
  prioridad int
  activo boolean
  fechaCreacion timestamp
  fechaActualizacion timestamp
  statusID int
  note: "ðŸ“‡ Contactos que reciben alertas por email"
}

// =====================================================
// RELACIONES (Foreign Keys)
// =====================================================

// === CORE - AnÃ¡lisis y EvaluaciÃ³n ===
AnalisisImagen.lotID > GROWER_LOT.lotID
AnalisisImagen.usuarioCreaID > MAST_USERS.userID

UmbralLuz.variedadID > GROWER_VARIETY.varietyID
UmbralLuz.usuarioCreaID > MAST_USERS.userID
UmbralLuz.usuarioActualizaID > MAST_USERS.userID

LoteEvaluacion.lotID > GROWER_LOT.lotID
LoteEvaluacion.variedadID > GROWER_VARIETY.varietyID
LoteEvaluacion.fundoID > GROWER_FARMS.farmID
LoteEvaluacion.sectorID > GROWER_STAGE.stageID
LoteEvaluacion.umbralIDActual > UmbralLuz.umbralID

// === Alertas y Notificaciones ===
Alerta.lotID > GROWER_LOT.lotID
Alerta.loteEvaluacionID > LoteEvaluacion.loteEvaluacionID
Alerta.umbralID > UmbralLuz.umbralID
Alerta.variedadID > GROWER_VARIETY.varietyID
Alerta.usuarioResolvioID > MAST_USERS.userID

Mensaje.alertaID > Alerta.alertaID
Mensaje.fundoID > GROWER_FARMS.farmID

MensajeAlerta.mensajeID > Mensaje.mensajeID
MensajeAlerta.alertaID > Alerta.alertaID

// === Usuarios y Dispositivos ===
Dispositivo.usuarioCreaID > MAST_USERS.userID
Dispositivo.usuarioModificaID > MAST_USERS.userID

UsuarioWeb.usuarioCreaID > UsuarioWeb.usuarioID
UsuarioWeb.usuarioModificaID > UsuarioWeb.usuarioID

Contacto.fundoID > GROWER_FARMS.farmID
Contacto.sectorID > GROWER_STAGE.stageID
Contacto.usuarioCreaID > MAST_USERS.userID
Contacto.usuarioActualizaID > MAST_USERS.userID

// =====================================================
// NOTAS PARA ORGANIZACIÃ“N VISUAL
// =====================================================
// 
// En eraser.io, despuÃ©s de aplicar este cÃ³digo:
// 
// 1. AGRUPA las tablas manualmente por categorÃ­as:
//    - Arriba: Referencias Externas (GROWER_*, MAST_*)
//    - Centro-Izquierda: Core (AnalisisImagen, UmbralLuz, LoteEvaluacion)
//    - Centro-Derecha: Alertas (Alerta, Mensaje, MensajeAlerta)
//    - Abajo: Usuarios (Dispositivo, UsuarioWeb, Contacto)
// 
// 2. USA el botÃ³n "Text" o "Note" para agregar notas explicativas:
//    - Ver dbschema/FLUJO_AGRICQR_DIAGRAMA.md para notas sugeridas
// 
// 3. FLUJO AGRICQR (agregar como nota visual):
//    Dispositivo â†’ AnalisisImagen â†’ LoteEvaluacion â†’ Alerta â†’ Mensaje â†’ Contacto
// 
//    AutenticaciÃ³n: AgriQR â†’ POST /api/auth/login â†’ Dispositivo (tabla)
//    Upload: AgriQR â†’ POST /api/photos/upload â†’ AnalisisImagen
//    Procesamiento: Trigger â†’ LoteEvaluacion â†’ Alerta â†’ Mensaje â†’ Email
//
